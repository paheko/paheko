# Paheko Snuffleupagus configuration
# -----------------------------------
#
# Use this file to harden a Paheko setup using snuffleupagus:
# https://github.com/jvoisin/snuffleupagus
#
# The aim is to prevent any remote code execution attack, even if
# code could be inserted.
#
# This configuration is targeted for Paheko, and it will lead to
# broken pages if used mixed with other PHP applications.
#
# This file has been generated by using Snuffleupagus script,
# see https://github.com/jvoisin/snuffleupagus/pull/484
# https://github.com/jvoisin/snuffleupagus/issues/486
# https://github.com/jvoisin/snuffleupagus/issues/485

# Disable execution of writable PHP files (disabled by default, but recommended)
# Make sure all PHP files are read-only for FPM to enable this setting.
# For example: chown -R www-data:www-data /var/www/paheko && chmod -R u=rX /var/www/paheko
#
#sp.readonly_exec.enable();

# Enable XXE protection
sp.xxe_protection.enable();

# Allow eval() for 'math' modifier (only allows math expressions)
sp.disable_function.function("eval").filename_r("include/lib/Paheko/UserTemplate/Modifiers\.php").allow();

# Allow eval() for evaluating Gettext plural rules, if Gettext is not installed
sp.disable_function.function("eval").filename_r("include/lib/KD2/Translate\.php").allow();

# Allow execution of commands at the only place where it should be
sp.disable_function.function("function_exists").filename_r("include/lib/Paheko/Utils\.php").allow();
sp.disable_function.function("proc_open").filename_r("include/lib/Paheko/Utils\.php").allow();
sp.disable_function.function("proc_get_status").filename_r("include/lib/Paheko/Utils\.php").allow();
sp.disable_function.function("proc_terminate").filename_r("include/lib/Paheko/Utils\.php").allow();
sp.disable_function.function("proc_close").filename_r("include/lib/Paheko/Utils\.php").allow();

# Disallow dangerous functions
sp.disable_function.function("unserialize").drop();
sp.disable_function.function("shell_exec").drop();
sp.disable_function.function("exec").drop();
sp.disable_function.function("passthru").drop();
sp.disable_function.function("php_uname").drop();
sp.disable_function.function("popen").drop();
sp.disable_function.function("posix_kill").drop();
sp.disable_function.function("posix_mkfifo").drop();
sp.disable_function.function("posix_setpgid").drop();
sp.disable_function.function("posix_setsid").drop();
sp.disable_function.function("posix_setuid").drop();
sp.disable_function.function("posix_setgid").drop();
sp.disable_function.function("posix_uname").drop();
sp.disable_function.function("proc_close").drop();
sp.disable_function.function("proc_nice").drop();
sp.disable_function.function("proc_open").drop();
sp.disable_function.function("proc_terminate").drop();
sp.disable_function.function("proc_get_status").drop();
sp.disable_function.function("dl").drop();
sp.disable_function.function("pnctl_exec").drop();
sp.disable_function.function("pnctl_fork").drop();
sp.disable_function.function("system").drop();
sp.disable_function.function("eval").drop();


### Here are some interesting bits from Snuffleupagus default config:

# Prevent various `mail`-related vulnerabilities
sp.disable_function.function("mail").param("additional_parameters").value_r("\\-").drop();

# Since it's now burned, me might as well mitigate it publicly
sp.disable_function.function("putenv").param("assignment").value_r("LD_").drop()
sp.disable_function.function("putenv").param("assignment").value("PATH").drop()

# This one was burned in Nov 2019 - https://gist.github.com/LoadLow/90b60bd5535d6c3927bb24d5f9955b80
sp.disable_function.function("putenv").param("assignment").value_r("GCONV_").drop()

# Prevent various `include`-related vulnerabilities
sp.disable_function.function("require_once").value_r("\.php$").allow();
sp.disable_function.function("include_once").value_r("\.php$").allow();
sp.disable_function.function("require").value_r("\.php$").allow();
sp.disable_function.function("include").value_r("\.php$").allow();
sp.disable_function.function("require_once").drop()
sp.disable_function.function("include_once").drop()
sp.disable_function.function("require").drop()
sp.disable_function.function("include").drop()

# Prevent runtime modification of interesting things
sp.disable_function.function("ini_set").param("option").value("assert.active").drop();
sp.disable_function.function("ini_set").param("option").value("zend.assertions").drop();
sp.disable_function.function("ini_set").param("option").value("memory_limit").drop();
sp.disable_function.function("ini_set").param("option").value("include_path").drop();
sp.disable_function.function("ini_set").param("option").value("open_basedir").drop();

# Detect some backdoors via environment recon
sp.disable_function.function("ini_get").param("option").value("open_basedir").drop();
sp.disable_function.function("ini_get").param("option").value_r("suhosin").drop();
sp.disable_function.function("function_exists").param("function").value("eval").drop();
sp.disable_function.function("function_exists").param("function").value("exec").drop();
sp.disable_function.function("function_exists").param("function").value("system").drop();
sp.disable_function.function("function_exists").param("function").value("shell_exec").drop();
sp.disable_function.function("function_exists").param("function").value("proc_open").drop();
sp.disable_function.function("function_exists").param("function").value("passthru").drop();
sp.disable_function.function("is_callable").param("value").value("eval").drop();
sp.disable_function.function("is_callable").param("value").value("exec").drop();
sp.disable_function.function("is_callable").param("value").value("system").drop();
sp.disable_function.function("is_callable").param("value").value("shell_exec").drop();
sp.disable_function.function("is_callable").param("value").value("proc_open").drop();
sp.disable_function.function("is_callable").param("value").value("passthru").drop();

# File upload
sp.disable_function.function("move_uploaded_file").param("to").value_r("\.php").drop();
